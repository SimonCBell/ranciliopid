<div>
   <table>
      <tbody>
         <tr>
            <td>
               <input id="clickMe2" type="button" value="clear" onclick="clear_table();" />
            </td>
            <td>
               <input id="clickMe" type="button" value="save" onclick="save_data();" />
            </td>
         </tr>
      </tbody>
   </table>
      

<div id=table></div>

<script>

   Date.prototype.secs = function() {
      var mm = this.getMinutes();
      var ss = this.getSeconds();

      var totSecs = 60*mm + ss;

      return totSecs;
   };

   var TimeTempVals = [];
   var startTime = new Date();
   var startTimeSecs = startTime.secs();



   
   function updateTemp(jsonValue) {
      var keys = Object.keys(jsonValue);

      // DateFormat formatter = new SimpleDateFormat("HH:mm:ss");
      // var date = formatter.format(new Date());

      var date = new Date();
      var secsNow = date.secs();

      var secsSinceStart = secsNow - startTimeSecs;

      console.log('secsNow');
      console.log(secsNow);
      console.log('startTimesecs');
      console.log(startTimeSecs);
      console.log('secsSinceStart');
      console.log(secsSinceStart);
   
      const curTempKey = keys[0];
      var curTemp = Number(jsonValue[curTempKey]);
      console.log(curTemp);

      TimeTempVals.push([secsSinceStart ,curTemp]);
   }


   if (!!window.EventSource) {
      var source = new EventSource('/events');
   
      source.addEventListener(
         'new_status',
         function (e) {
            console.log("new_status", e.data);
            var myObj = JSON.parse(e.data);
            console.log(myObj);
            updateTemp(myObj);
            updateTable();
         }
      )
   }

   function updateTable() { 
      var s = '<table><tbody>';
      s += '<tr><th><b>Time</b></th><th><b>Temp</b></th></tr>';

      for (const element of TimeTempVals) {
         s = s +'<tr><td>' + element[0] + '</td>' + '<td>' + element[1] + '</td></tr>' ;
      }

      s += '</tbody></table>';

      document.getElementById("table").innerHTML = s 
   }

   function save_data(){

      let csvContent = "data:text/csv;charset=utf-8," 
         + TimeTempVals.map(e => e.join(",")).join("\n");
      
      var encodedUri = encodeURI(csvContent);
      window.open(encodedUri);
   }

   function clear_table(){
      TimeTempVals = [];
      startTime = new Date();
      startTimeSecs = startTime.secs();
      updateTable();
   }

</script>
